# Copilot Instructions for ini-es

- Project scope: ESM/TypeScript rewrite of npm/ini; all exports are pure functions re-exported through [src/index.ts](../src/index.ts).
- Encoding: [src/encode.ts](../src/encode.ts) turns nested objects into INI strings. Options include `align` (pads keys and forces `whitespace`), `whitespace` (spaces around `=`), `newline` (blank line after section headers), `sort` (alphabetize keys/sections), `section` (prefix for nested recursion), `bracketedArray` (append `[]` to array keys), and `platform` (win32 â†’ CRLF, otherwise LF; falls back when `process` is undefined).
- Section traversal: children with object values recurse into new sections; section names are escaped via `splitSections` so literal dots can be kept when written as `\.` in keys.
- Decoding: [src/decode.ts](../src/decode.ts) parses lines with a single regex; ignores blank/comment lines (`;` or `#`). `bracketedArray` true treats `[]` suffix as arrays; when false, repeated keys become arrays via occurrence counting. Keys named `__proto__` are discarded to avoid prototype pollution. Values `true/false/null` JSON-parse to booleans/null; others stay strings.
- Escaping: [src/safe.ts](../src/safe.ts) stringifies values containing `=`, newlines, leading/trailing spaces, brackets, or existing quotes, and escapes `;`/`#` to avoid comment parsing. [src/unsafe.ts](../src/unsafe.ts) unescapes, strips comments unless escaped, and JSON-parses quoted strings (supports single-quote stripping before parse).
- Utilities: [src/utils.ts](../src/utils.ts) supplies `hasOwn`, `isQuoted`, and `splitSections` that respects escaped separators when splitting section names.
- Types: `AnyObject` is just `Record<string, any>` ([src/types.ts](../src/types.ts)); keep APIs generic over it rather than introducing stricter shapes unless required.
- Platform guardrails: Tests stub `process.platform` via Vitest `stubEnv`; keep encode/decode browser-safe (no hard Node imports; tsconfig `types: []` with `moduleResolution: "Bundler"`).
- Tests: Vitest with snapshots in [tests/encode.test.ts](../tests/encode.test.ts), [tests/decode.test.ts](../tests/decode.test.ts), [tests/win32.test.ts](../tests/win32.test.ts); fixtures loaded with `?raw` in [tests/fixtures/index.ts](../tests/fixtures/index.ts). Update snapshots when changing formatting behavior.
- Behavior edge cases covered in tests: handling of escaped dots in section names, ignoring junk before first section, boolean/null parsing, bracketed vs duplicated array semantics, comment escaping via `\;`/`\#`, and avoidance of blank first/last lines on encode.
- Build toolchain: `pnpm build` uses tsdown ([tsdown.config.ts](../tsdown.config.ts)) with `platform: neutral`, emits CJS-free ESM + dts. `pnpm dev` runs tsdown watch. `pnpm typecheck` uses `tsc --noEmit`. `pnpm lint` runs eslint. Default test command is `pnpm test`.
- Publishing/release: `pnpm prepublishOnly` builds; release workflow runs `lint typecheck test` via `release:check` before `bumpp` versioning.
- Contribution tips: prefer adding options in EncodeOptions/DecodeOptions with defaults maintained; keep functions pure and tree-shakable; maintain array handling compatibility with npm/ini; guard against prototype pollution when introducing new parse paths.
